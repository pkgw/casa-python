<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" ?>
<casaxml xmlns="http://casa.nrao.edu/schema/psetTypes.html"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://casa.nrao.edu/schema/casa.xsd
file:///opt/casa/code/xmlcasa/xml/casa.xsd">


<!-- This is the param set for sdflag -->

<task type="function" name="sdflag2" startup="false" category="single dish" visibility="experimental">

  <shortdescription>ASAP SD spectral flagging task </shortdescription>


  <description>
        ASAP SD spectral/row flagging task (based on the ALMATST5 recommendations):

        Task Version 2008-01-31 TT
</description>

  <input>

    <param type="string" name="infile"  mustexist="true">
    <description>name of input SD dataset</description>
    <value></value>
    </param>

    <param type="any" name="antenna">
            <description>antenna name or id (only effective for MS input)</description>
            <any type="variant" limittype="string int"/>
            <value type="int">0</value>
    </param> 

    <param type="string" name="specunit">
	<shortdescription>units for spectral axis [\'channel\'|\'km/s\'|\'GHz\'] (\'\'=channel)</shortdescription>
        <description>units for spectral axis</description>
	<value></value>
	<allowed kind="enum">
	    <value></value>
	    <value>channel</value>
	    <value>km/s</value>
	    <value>GHz</value>
	    <value>MHz</value>
	    <value>kHz</value>
	    <value>Hz</value>
        </allowed>
    </param>

    <param type="any" name="restfreq" subparam="true">
        <description>rest frequency (default unit: Hz)</description>
        <any type="variant" limittype="double int string doubleArray intArray stringArray dictArray" />
        <value type="string"></value>
    </param>

    <param type="string" name="frame">
            <shortdescription>frequency reference frame [\'lsrk\'|\'lsrd\'|\'bary\'|\'geo\'|\'topo\'|\'galacto\'|\'lgroup\'|\'cmb\'] (\'\'=current frame) </shortdescription>
	    <description>frequency reference frame (\'\'=current)</description>
	    <value></value>
            <allowed kind="enum">
                    <value>lsrk</value>
                    <value>lsrd</value>
                    <value>bary</value>
                    <value>geo</value>
                    <value>topo</value>
                    <value>galacto</value>
                    <value>lgroup</value>
                    <value>cmb</value>
                    <value></value>
           </allowed>
    </param>

    <param type="string" name="doppler">
	    <shortdescription>doppler convention [\'radio\'|\'optical\'|\'z\'|\'beta\'|\'gamma\'](\'\'=current)</shortdescription>
	    <description>doppler convention (\'\'=current)</description>
	    <value></value>
            <allowed kind="enum">
                    <value>radio</value>
                    <value>optical</value>
                    <value>z</value>
                    <value>beta</value>
                    <value>gamma</value>
                    <value></value>
           </allowed>
    </param>

    <param type="string" name="mode">
	    <shortdescription>mode of data selection and flag operation [\'manual\'|\'clip\'|\'interactive\'|\'rowid\'(expert)]</shortdescription>
	    <description>mode of data selection and flag operation</description>
            <value>manual</value>
            <allowed kind="enum">
            <value>manual</value>
            <value>clip</value>
            <value>interactive</value>
            <value>rowid</value>
            </allowed>
    </param>


<!-- Common sub-parameters for ALL modes but 'interactive'-->
    <param type="bool" name="unflag" subparam="true">
            <description>unflag selected data (False: flag, True: unflag)</description>
            <value>False</value>
    </param>

<!-- Common sub-parameters for ALL modes but 'rowid'-->

    <param type="intArray" name="scans" subparam="true">
	    <description>list of scan numbers to process (e.g. [1,2,3,4])</description>
	    <value></value>
    </param>

    <param type="string" name="field" subparam="true">
	    <description>selection string for selecting by source name (e.g., \'FLS3a*\')</description>
	    <value></value>
    </param>

    <param type="string" name="timerange" subparam="true">
	    <description>selection string for selecting by time range (e.g., \'09:14:0~09:54:0\')</description>
	    <value></value>
    </param>

    <param type="intArray" name="ifs" subparam="true">
	    <shortdescription>list of IF id numbers to select (e.g. [0,1])</shortdescription>
	    <value></value>
    </param>

    <param type="any" name="pols" subparam="true">
	    <description>list of polarization by ids or names to select (e.g. [0,1])</description>
            <any type="variant" limittype="intArray stringArray"/>
	    <value type="intArray"></value>
    </param>

<!-- For mode='manual' -->
    <param type="intArray" name="maskflag" subparam="true">
            <description>list of mask regions to flag/unflag (e.g., [[0,500],[1000,1500]])</description>
            <value></value>
    </param>


<!-- For mode='clip' -->
    <param type="any" name="clipminmax" subparam="true">
            <description>range of data that will NOT be flagged</description>
            <any type="variant" limittypes="doubleArray doubleArrayArray"/>
            <value type="doubleArray"></value>
    </param>

    <param type="any" name="clipoutside" subparam="true">
            <description>clip outside the range, or within it</description>
            <any type="variant" limittypes="bool boolArray"/>
            <value type="bool">True</value>
    </param>


<!-- For mode='interactive' -->
    <param type="bool" name="showflagged" subparam="true">
            <description>show flagged data (in gray) on plots</description>
            <value>False</value>
    </param>

<!-- For mode='rowid' -->
    <param type="intArray" name="rows" subparam="true">
            <description>list of row IDs to apply row-based flagging/unflagging (e.g., [0,3,5])</description>
            <value></value>
    </param>


    <param type="string" name="outfile">
            <description>name of output file (See a WARNING in help document)</description>
            <value></value>
    </param>

    <param type="string" name="outform">
            <shortdescription>output file format [\'ASCII\'|\'MS\'|\'SDFITS\'|\'ASAP\'] (See a WARNING in help document)</shortdescription>
            <description>output file format (See a WARNING in help document)</description>
            <value>ASAP</value>
            <allowed kind="enum">
            <value>ASCII</value>
            <value>ascii</value>
            <value>MS</value>
            <value>ms</value>
            <value>MS2</value>
            <value>ms2</value>
            <value>SDFITS</value>
            <value>sdfits</value>
            <value>ASAP</value>
            <value>asap</value>
            </allowed>

    </param>

    <param type="bool" name="overwrite">
            <description>overwrite the output file if already exists (See a WARNING in help document)</description>
            <value>True</value>
    </param>

    <param type="int" name="plotlevel">
            <description>control for plotting of results</description>
            <value>0</value>
    </param>

    <constraints>
	    <when param="specunit">
		<equals value=""/>
		<equals value="channel"/>
		<equals value="GHz"/>
		<equals value="MHz"/>
		<equals value="kHz"/>
		<equals value="Hz"/>
		<equals value="km/s">
			<default param="restfreq"><value type='string'></value></default>
                </equals>
	    </when>
            <when param="mode">
                    <equals value="manual">
                            <default param="scans"><value type="intArray"></value></default>
                             <default param="field"><value type="string"></value></default>
                             <default param="timerange"><value type="string"></value></default>
                             <default param="ifs"><value type="intArray"></value></default>
                             <default param="pols"><value type="intArray"></value></default>
                           <default param="maskflag"><value type="intArray"></value></default>
                            <default param="unflag"><value type="bool">False</value></default>
                    </equals>
                    <equals value="clip">
                            <default param="scans"><value type="intArray"></value></default>
                             <default param="field"><value type="string"></value></default>
                             <default param="timerange"><value type="string"></value></default>
                             <default param="ifs"><value type="intArray"></value></default>
                             <default param="pols"><value type="intArray"></value></default>
                            <default param="clipminmax"><value type="doubleArray"></value></default>
                            <default param="clipoutside"><value type="bool">True</value></default>
                            <default param="unflag"><value type="bool">False</value></default>
                    </equals>
                    <equals value="interactive">
                            <default param="scans"><value type="intArray"></value></default>
                             <default param="field"><value type="string"></value></default>
                             <default param="timerange"><value type="string"></value></default>
                             <default param="ifs"><value type="intArray"></value></default>
                             <default param="pols"><value type="intArray"></value></default>
                            <default param="showflagged"><value type="bool">False</value></default>
                    </equals>
                    <equals value="rowid">
                            <default param="rows"><value type="intArray"></value></default>
                            <default param="unflag"><value type="bool">False</value></default>
                    </equals>
            </when>
    </constraints>

    </input>

  <returns type="void"/>

  <example>
        Keyword arguments:
        infile -- name of input SD dataset
        antenna -- antenna name or id (only effective for MS input). 
        specunit -- units for spectral axis
                options: (str) 'channel','km/s','GHz','MHz','kHz','Hz',''
                default: '' (=current)
                example: this will be the units for maskflag
            &gt;&gt;&gt; specunit expandable parameters
                 restfreq -- rest frequency
                         available type includes float, int, string, list of float, 
                         list of int, list of string, and list of dictionary. the 
                         default unit of restfreq in case of float, int, or string 
                         without unit is Hz. string input can be a value only 
                         (treated as Hz) or a value followed by unit for which 'GHz',
                         'MHz','kHz',and 'Hz' are available. 
                         a list can be used to set different rest frequencies for 
                         each IF. the length of list input must be nIF. dictionary 
                         input should be a pair of molecule name and frequency with 
                         keys of 'name' and 'value', respectively. values in the 
                         dictionary input follows the same manner as for single 
                         float or string input. 
                         example: 345.796
                                  '1420MHz'
                                  [345.8, 347.0, 356.7]
                                  ['345.8MHz', '347.0MHz', '356.7MHz']
                                  [{'name':'CO','value':345}]
        frame -- frequency frame for spectral axis
                options: (str) 'LSRK','REST','TOPO','LSRD','BARY',
                         'GEO','GALACTO','LGROUP','CMB'
                default: currently set frame in scantable
                WARNING: frame='REST' not yet implemented
        doppler -- doppler mode
                options: (str) 'RADIO','OPTICAL','Z','BETA','GAMMA'
                default: currently set doppler in scantable
        mode -- type of flag operation
                options: (str) 'manual', 'clip', 'interactive', 'rowid'
                default: 'manual'

             >>> common data selection parameters for all modes except mode='rowid'
                scans -- list of scan numbers to process
                        default: [] (use all scans)
                        example: [21,22,23,24]
                        this selection is in addition to field, timerange,
                        ifs and pols
                field -- selection string for selecting scans by name
                        default: '' (no name selection)
                        example: 'FLS3a*'
                        this selection is in addition to scans, timerange,
                        ifs, and pols
                timerange -- selection string for selecting timerange
                        default: '' (no timerange selection)
                        example: '09:14:0~09:54:0'
                        this selection is in addition to scans, fields, ifs,
                        and pols
                ifs -- list of IF id numbers to select
                        default: [] (use all IFs)
                        example: [15]
                        this selection is in addition to scans, field,
                        timerange, ifs, and pols
                pols -- list of polarization id numbers to select
                        default: [] (use all polarizations)
                        example: [1]
                        this selection is in addition to scans, field,
                        timerange, and ifs

             >>> mode='manual' expandable parameters
                maskflag -- list of mask regions to apply flag/unflag 
                            Note, this parameter is ignored if one or more rows are 
                            given in flagrow, or clip=True.
                        default: [] (entire spectrum)
                        example: [[1000,3000],[5000,7000]]

             >>> mode='clip' expandable parameters
                clipminmax -- range of data that will NOT be flagged
                        default: [] (means no clip operation)
                        example: [0.0,1.5]
                clipoutside -- clip OUTSIDE the range ?
                        options: (bool)True,False
                        default: True
                        example: clipoutside=False means flag data WITHIN the range.
             >>> mode='interactive' expandable parameters
                showflagged -- show flagged data on plots
                        default: False
             >>> mode='rowid' expandable parameters
                rows -- a list of row IDs to apply flag/unflag in the input scannable
                        Note, this parameter is effective only when one or more row 
                        IDs are given explicitly
                        default: [] (means no selection)
                        example: [0, 2, 3]
        unflag -- flag or unflag
                default: False (flag selected data)
                options: (bool) True, False
        outfile -- Name of output file
                default: ''
                Note: by default (outfile=''), actual output file name is set as follows: 
                      (1) if overwrite=True (default), infile (input) will be overwritten.
                      WARNING: If the formats of input and ouput files are different, 
                               this causes complete loss of input file.
                      (2) if overwrite=False, outfile will be &lt;infile&gt;_f. 
        outform -- format of output file
                options: 'ASCII','SDFITS','MS','ASAP'
                default: 'ASAP'
                example: the ASAP format is easiest for further sd
                         processing; use MS for CASA imaging.
                WARNING: Be sure outform is same as the input file format when you 
                         overwrite the input file by overwrite=True and outfile='' (default).
        overwrite -- overwrite the output file if already exists
                options: (bool) True,False
                default: True
                WARNING: input file is overwritten if overwrite=True and outfile='' (default). 
                         This causes the complete loss of input file if the formats of
                         input and ouput files are different.
        plotlevel -- control for plotting of results
                options: (int) 0=none, 1=some, 2=more, &lt;0=hardcopy
                default: 0 (no plotting)
                example: plotlevel&lt;0 as abs(plotlevel), e.g.
                         -1 => hardcopy of final plot (will be named
                         &lt;outfile&gt;_flag.eps)
                WARNING: be careful plotting in fsotf mode!

        -------------------------------------------------------------------

        DESCRIPTION:

        Task sdflag2 performs either interactive or non-interactive channel/row 
        based flagging on spectra. 
        Currently, there are three ways of non-interactive flagging available: 
        (1) channel or row based flagging by selecting spectra by field,
        lists of scan numbers, IF numbers, and polarization idices in mode='manual',
        (2) channel based flagging by specifying a range of spectral values in
        mode='clip', and 
        (3) row based flagging by specifying a list of row numbers in 
        mode='rowid'. Note this is an EXPERT mode.

        In mode='manual', the channel based flagging are invoked when regions
        in channel, frequency, or velocity are specified to maskflag parameter. 
        Otherwise, the whole channels are flagged for the selected spectra.
        Note the mode='rowid' is an EXPERT mode since it might not be straight
        forward for general users to select data by row IDs in scantable.

        Interactive flagging is available when mode='interactive'. 
        The available ways of interactive flagging include: 
        (1) row based flagging by selecting 'panel' and (2) channel
        based flagging by selecting 'region's of channels on Flag plotter. 
        See the cookbook for details of how to select channel regions and spectra
        on the plotter.

        NOTE the task sdflag2 only modifies flag information, FLAGROW and FLAGTRA, 
        in the input scantable, and does not filter rows in the dataset unlike
        sdflag task.

        If plotlevel&gt;=1, the task asks you if you really apply the 
        flags before it is actually written to the data with a plot 
        indicating flagged regions.
        Please note that this task is still experimental.

        WARNING for overwrite option:
        Be sure 'outform' is the same as data format of input file when you
        overwrite it. The default value of the option 'overwrite'
        is True in this task, thereby the current dataset (infile) is 
        overwritten unless a different file name is set to outfile. 
        There is a known issue in overwriting infile. If 'outform' differs to the
        data format of infile, the data is overwritten with the new data format 
        (specified by 'outform') and the data in the original format will be lost.

        WARNING for the GBT raw SDFITS format data as input:
        SDtasks are able to handle GBT raw SDFITS format data since the 
        data filler is available. However, the functionality is not well 
        tested yet, so that there may be unknown bugs.  
 
  </example>

</task>

</casaxml>
