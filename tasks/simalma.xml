<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" ?>
<casaxml xmlns="http://casa.nrao.edu/schema/psetTypes.html"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://casa.nrao.edu/schema/casa.xsd
file:///opt/casa/code/xmlcasa/xml/casa.xsd">
  
<task type="function" name="simalma" category="simulation" visibility="experimental">

  <shortdescription>(Experimental) simple simulation task for ALMA </shortdescription>
  <description>
    This task will simulate ALMA 12-m, ACA-7m and total power array data, 
   and image and analyze them. Please contact CASA helpdesk with questions.
  </description>
  
  <input>
    
    <param type="string" name="project">
      <description>root prefix for output file names</description>
      <value>sim</value>
    </param>
    



    <!-- all parms default to keep what's in the image, if the param=="" -->

    <param type="string" name="skymodel">
      <description>model image to observe</description>
      <value type="string"></value>
    </param>

    <param type="string" name="inbright" subparam='true'>
       <description>scale surface brightness of brightest pixel e.g. "1.2Jy/pixel"</description>
       <value type="string"></value>
    </param>
    <!-- TODO parse Jy/pixel, MJy/Sr, eventually K, etc -->
    <!-- TODO document permitted units in online help -->

    <param type="string" name="indirection" subparam="true">
      <description>set new direction e.g. "J2000 19h00m00 -40d00m00"</description>
      <value type="string"></value>
    </param>

    <param type="string" name="incell" subparam='true'>
      <description>set new cell/pixel size e.g. "0.1arcsec"</description>
      <value type="string"></value>
    </param>
    
    <param type="string" name="incenter" subparam="true">
      <description>set new frequency of center channel e.g. "89GHz" (required even for 2D model)</description>
      <value type="string"></value>
    </param>    

    <param type="string" name="inwidth" subparam="true">
      <description>set new channel width e.g. "10MHz" (required even for 2D model)</description>
      <value type="string"></value>
    </param>



    <param type="string" name="complist">
      <description>componentlist to observe</description>
      <value></value>
    </param>

    <param type="string" name="compwidth" subparam="true">
      <description>bandwidth of components</description>
      <value>"8GHz"</value>
    </param>



<!--*************************************************************-->
<!--*************************************************************-->


    <param type="bool" name="setpointings">
      <description></description>
      <value>True</value>
    </param>

    <param type="string" name="ptgfile" subparam="true">
      <description>list of pointing positions</description>
      <value type="string">$project.ptg.txt</value>
    </param>

    <param type="string" name="integration" subparam="true">
      <description>integration (sampling) time</description>
      <value>10s</value>
    </param>

    <param type="stringArray" name="direction" subparam="true">
      <description>"J2000 19h00m00 -40d00m00" or "" to center on model</description>
      <value type="string"></value>
    </param>

    <param type="stringArray" name="mapsize" subparam="true">
      <description>angular size of map or "" to cover model</description>
      <value type="vector">
	<value type="string"></value>
	<value type="string"></value>
      </value>
    </param>

<!--
    <param type="string" name="maptype" subparam="true">
      <description>hexagonal, square, etc</description>
      <value type="string">hexagonal</value>
      <allowed kind="enum">
	<value type="string">hexagonal</value>
	<value type="string">square</value>
	<value type="string">hex</value>
	<value type="string">ALMA</value>
	<value type="string">alma</value>
	<value type="string">ALMA-OT</value>
      </allowed>
    </param>
-->

<!--
    <param type="string" name="pointingspacing" subparam="true">
      <description>spacing in between pointings or "0.25PB" or "" for 0.5 PB</description>
      <value></value>
    </param>
-->

<!--
    <param type="string" name="caldirection" subparam="true">
      <description>pt source calibrator [experimental]</description>
      <value type="string"></value>
    </param>

    <param type="string" name="calflux" subparam="true">
      <description></description>
      <value>1Jy</value>
    </param>
-->






<!--*************************************************************-->
<!--  observe always reads from $project.skymodel file now -->

<!--
    <param type="bool" name="observe">
      <description></description>
      <value>True</value>
    </param>
-->

<!--
    <param type="string" name="obsmode">
      <description>observation mode to simulate [int(interferometer)|sd(singledish)|""(none)]</description>
      <value>int</value>
      <allowed kind="enum">
	<value type="string"></value>
	<value type="string">int</value>
	<value type="string">sd</value>
      </allowed>
    </param>
-->

<!--
    <param type="string" name="refdate" subparam="true">
      <description>date of observation - not critical unless concatting simulations</description>
      <value>2014/01/01</value>
    </param>
-->


    <param type="string" name="antennalist">
      <description>antenna position file of ALMA 12m array</description>
      <value>alma_cycle1_1.cfg</value>
    </param>


    <param type="string" name="hourangle">
      <description>hour angle of observation center e.g. -3:00:00, or "transit"</description>
      <value>transit</value>
    </param>
    
    <param type="string" name="totaltime">
      <description>total time of observation or number of repetitions</description>
      <value>7200s</value>
    </param>

<!-- TODO put in more than one synth_antfile to do ALMA and ACA config - 
it'll do them for the same amount of time -->

<!--
    <param type="string" name="sdantlist" subparam="true">
      <description>single dish antenna position file</description>
      <value></value>
    </param>

    <param type="int" name="sdant" subparam="true">
      <description>single dish antenna index in file</description>
      <value>0</value>
    </param>

-->
    <param type="double" name="acaratio">
      <description>Ratio of the total observation time for ACA in relation to 12-m array or 0 for no ACA</description>
      <value>0.0</value>
      <allowed kind="range"><value range="min">0</value></allowed>
    </param>

    <param type="string" name="acaconfig" subparam="true">
      <description>Antenna configuration of ACA 7-m array [""|"cycle1"|"i"|"ns"]</description>
      <value></value>
    </param>




<!--  NOISE  -->

    <param type="double" name="pwv">
      <description>Precipitable Water Vapor in mm. 0 for noise-free simulation</description>
      <value>0.0</value>
      <allowed kind="range"><value range="min">0</value></allowed>
    </param>

<!--
    <param type="string" name="thermalnoise">
      <description>add thermal noise: [tsys-atm|tsys-manual|""]</description>
      <value type="string"></value>
      <allowed kind="enum">
	<value type="string"></value>
	<value type="string">tsys-atm</value>
	<value type="string">tsys-manual</value>
	<value type="string">False</value>
	<value type="string">F</value>
      </allowed>
    </param>    
    <param type="double" name="user_pwv" subparam="true">
      <description>Precipitable Water Vapor in mm</description>
      <value>1.</value>
      <allowed kind="range"><value range="min">0</value></allowed>
    </param>

    <param type="double" name="t_ground" subparam="true">
      <description>ambient temperature</description><value>270.</value>
      <allowed kind="range"><value range="min">0</value></allowed>
    </param>
    <param type="double" name="t_sky" subparam="true">
       <description>atmospheric temperature</description>
       <value>260.</value>
      <allowed kind="range"><value range="min">0</value></allowed>
    </param>	
    <param type="double" name="tau0" subparam="true">
      <description>zenith opacity</description><value>0.1</value>
      <allowed kind="range"><value range="min">0</value></allowed>
    </param>

    <param type="int" name="seed" subparam="true">
      <description>random number seed</description><value>11111</value>
    </param>
    
    <param type="double" name="leakage">
      <description>cross polarization (interferometer only)</description>
      <value>0.0</value>
      <allowed kind="range"><value range="min">0</value></allowed>
    </param>    
-->
    

<!--  IMAGE   -->    

    <param type="bool" name="image">
      <description>image simulated data</description>
      <value>True</value>
    </param>    

<!--
    <param type="string" name="vis" subparam='true'>
      <description>Measurement Set(s) to image</description>
      <value>default</value>
    </param>

    <param type="string" name="modelimage" subparam='true'>
      <description>prior image to use in clean e.g. existing single dish image</description>
      <value type="string"></value>
    </param>
-->
    
    <param type="intArray" name="imsize" subparam="true">
      <description>output image size in pixels (x,y) or 0 to match model</description>
      <value type="vector"><value>128</value><value>128</value></value>
    </param>

    <param type="string" name="imdirection" subparam="true">
      <description>set output image direction, (otherwise center on the model)</description>
      <value type="string"></value>
    </param>

    <param type="string" name="cell" subparam='true'>
      <description>cell size with units or "" to equal model</description>
      <value type="string"></value>
    </param>
    
    <param type="int" name="niter" subparam="true">
      <description>maximum number of iterations (0 for dirty image)</description>
      <value>500</value>
    </param>

    <param type="string" name="threshold" subparam="true">
      <description>flux level (+units) to stop cleaning</description>
      <value>0.1mJy</value>
    </param>

<!--
    <param type="string" name="weighting" subparam="true">
      <description>weighting to apply to visibilities</description>
      <value>natural</value>
      <allowed kind="enum">
	<value>natural</value>
	<value>uniform</value>
	<value>briggs</value>  
      </allowed>
    </param>

    <param type="any" name="mask" subparam="true">
      <description>Cleanbox(es), mask image(s), region(s), or a level</description>
      <any type="variant"/>
      <value type="vector"><value></value></value>
    </param>

    <param type="stringArray" name="outertaper" subparam="true">
      <description>uv-taper on outer baselines in uv-plane</description>
      <value type="vector">
	<value></value>
      </value>
    </param>


    <param type="string" name="stokes" subparam="true">
      <description>Stokes params to image</description>
      <value>I</value>
      <allowed kind="enum">
	<value>I</value>
	<value>IV</value>
	<value>QU</value>
	<value>IQUV</value>
	<value>RR</value>
	<value>LL</value>
	<value>RRLL</value>
	<value>XX</value>
	    <value>YY</value>
	    <value>XXYY</value>
      </allowed>
    </param>
-->







    <param type="string" name="graphics">
      <description>display graphics at each stage to [screen|file|both|none]</description>
      <value type="string">both</value>
      <allowed kind="enum">
	<value>screen</value>
	<value>file</value>
	<value>both</value>
	<value>none</value>
	<value></value>
      </allowed>
    </param>

    <param type="bool" name="verbose">
      <description></description>
      <value>False</value>
    </param>

    <param type="bool" name="overwrite">
      <description>overwrite files starting with $project</description>
      <value>False</value>
    </param>



        
    
<!--  CONSTRAINTS  -->    
    
    <constraints>
      <when param="skymodel">
	<notequals value="">
	  <default param="inbright"><value type="string"></value></default>
	  <default param="indirection">
	    <value type="string"></value>
	  </default>
	  <default param="incell"><value type="string"></value></default>
	  <default param="incenter">
	    <description>set central frequency (required even for 2D image)</description>
	    <value type="string"></value>
	  </default>
	  <default param="inwidth">
	    <description>set channel width or bandwidth of 2D / continuum image</description>
	    <value type="string"></value>
	  </default>
	</notequals>
      </when>
      <!-- **********************************************************  -->
      <when param="complist">
	<notequals value="">
	  <default param="compwidth"><value type="string">8GHz</value></default>
	</notequals>
      </when>
      <!-- **********************************************************  -->
      <when param="setpointings">
	<equals type="bool" value="True">
	  <default param="integration"><value type="string">10s</value></default>
	  <default param="direction">
	    <description>center of map or "" to center on the model</description>
	    <value type="string"></value>
	  </default>
	  <default param="mapsize" type="stringArray">
	    <value type="vector">
	      <value type="string">''</value>
	      <value type="string">''</value>
	    </value>
	  </default>
<!--
	  <default param="maptype" type="string">
	    <value type="string">ALMA</value>
	  </default>
	  <default param="pointingspacing"><value type="string"></value></default>
-->
	</equals>
	<equals type="bool" value="False">
	  <default param="ptgfile"><value type="string">$project.ptg.txt</value></default>
	  <default param="integration"><value type="string">10s</value>
	  <description>integration time (see below)</description></default>
	</equals>
      </when>
      <!-- **********************************************************  -->
      <when param="acaratio">
	<notequals type="double" value="0">
	  <default param="acaconfig"><value type="string"></value></default>
	</notequals>
      </when>
<!--
      <when param="observe">
	<equals type="bool" value="True">
	  <default param="antennalist"><value type="string">alma.out10.cfg</value></default>
	  <default param="refdate"><value type="string">2014/05/21</value></default>
	  <default param="hourangle"><value type="string">transit</value></default>
	  <default param="totaltime"><value>"7200s"</value></default>
	  <default param="caldirection"><value type="string"></value></default>
	  <default param="calflux"><value type="string">1Jy</value></default>
          <default param="acaratio"><value type="double">0</value></default>
	</equals>
	<equals type="bool" value="False">
	  <default param="antennalist"><value type="string"></value>
	  <description>antenna info can be used to calculate the primary beam</description></default>
	  <default param="sdantlist"><value type="string"></value>
	  <description>antenna info can be used to calculate the primary beam</description></default>
	  <default param="sdant"><value type="int">0</value></default>
          <default param="useaca"><value>False</value></default>
 	</equals>
      </when>
-->
      <!-- **********************************************************  -->
<!--
      <when param="thermalnoise">
	<equals type="string" value=""/>
	<equals type="string" value="False"/>
	<equals type="string" value="F"/>
	<equals type="string" value="tsys-atm">
	  <default param="user_pwv"><value>1.</value></default>
	  <default param="t_ground"><value>269.</value></default>
	  <default param="seed"><value>11111</value></default>
	</equals>	
	<equals type="string" value="tsys-manual">
	  <default param="t_ground"><value>269.</value></default>
	  <default param="t_sky"><value>263.</value></default>
	  <default param="tau0"><value>0.1</value></default>
	  <default param="seed"><value>11111</value></default>
	</equals>
      </when>
-->
      <!-- **********************************************************  -->
      <when param="image">
	<equals type="bool" value="True">
<!--
	  <default param="vis"><value type="string">default</value></default>
	  <default param="modelimage"><value type="string"></value></default>
-->
	  <default param="imsize">
	    <value>0</value>
	  </default>
	  <default param="imdirection">
	    <value type="string"></value>
	  </default>
	  <default param="cell"><value type="string"></value></default>
	  <default param="niter"><value>500</value></default>
	  <default param="threshold"><value type="string">0.1mJy</value></default>
<!--
	  <default param="weighting"><value type="string">natural</value></default>
	  <default param="mask">      <value type="vector"><value></value></value></default>
	  <default param="outertaper"><value type="vector"><value></value></value></default>
	  <default param="stokes"><value type="string">I</value></default>
-->
	</equals>
	<equals type="bool" value="False"/>
      </when>
      <!-- **********************************************************  -->
    </constraints>
    
    
    
  </input>
  <returns type="bool"/>
  
<example>
ALMA simulation task:

    ##### WARNING: This task is EXPERIMENTAL #####
    This task simulates ALMA observation including 12-m, ACA 7-m and total
    power arrays, and images and analyzes simulated data.
    New functionality is actively being added, so if you have changed
    versions of CASA, check the inputs carefully.
    Please contact CASA experts with any questions, especially 
    about features noted below as *experimental*    
    -------------------------------
    project -- root filename for all output files.
    -------------------------------
    skymodel -- image model of the sky, 
         with optional parameters that can be overriden
    inbright -- peak brightness in Jy/pixel, or "" for unchanged
       * NOTE: "unchanged" will take the numerical values in your image 
         and assume they are in Jy/pixel, even if it says some other unit 
         in the header. 
    indirection -- central direction, or "" for unchanged
    incell -- spatial pixel size, or "" for unchanged
    incenter -- frequency of center channel e.g. "89GHz", or "" for unchanged
    inwidth -- width of channels, or "" for unchanged - this should be a 
         string representing a quantity with units e.g. "10MHz"
       * NOTE: only works reliably with frequencies, not velocities
       * NOTE: it is not possible to change the number of spectral planes
         of the sky model, only to relabel them with different frequencies
         That kind of regridding can be accomplished with the CASA toolkit.
    -------------------------------
    complist -- component list model of the sky, added to or instead of skymodel
    compwidth -- bandwidth of components; if simulating from components only, 
         this defines the bandwidth of the MS and output images
    -------------------------------
    setpointings -- calculate a map of pointings, or if false, provide ptgfile
       * if graphics are on, display the pointings shown on the model image
    ptgfile -- a text file specifying directions in the same 
         format as the example, and optional integration times, e.g.
         #Epoch     RA          DEC      TIME(optional)
         J2000 23h59m28.10 -019d52m12.35 10.0
       * if the time column is not present in the file, it will use
         "integration" for all pointings.
       * NOTE: at this time the file should contain only science pointings:
         simdata will observe these, then optionally the calibrator, 
         then the list of science pointings again, etc, until totaltime
         is used up. 
    integration --- Time interval for each integration e.g '10s'
       * NOTE: to simulate a "scan" longer than one integration, use 
         setpointings to generate a pointing file, and then edit the 
         file to increase the time at each point to be larger than 
         the parameter integration time.
    direction -- mosaic center direction e.g 'J2000 19h00m00 -40d00m00'
       * can optionally be a list of pointings
       * otherwise simdata will pack mapsize according to maptype
    mapsize -- angular size of map 
       * set to "" to span the model image
    -------------------------------
    antennalist -- ascii file containing antenna positions.
       * NOTE: In this task, it should be an ALMA configuration.
       * standard arrays are found in your CASA data repository, 
         os.getenv("CASAPATH").split()[0]+"/data/alma/simmos/"        
       * a string of the form "alma;0.5arcsec" will be parsed into a full 12m ALMA
         configuration.  This only works for full ALMA and may fail to find the 
         standard configuration files on some systems - see casaguides.nrao.edu
    hourangle -- hour angle of observation e.g. '-3h'
    totaltime --- total time of observation e.g '7200s' or if an number without
         units, interpreted as the number of times to repeat the map
    acaratio  --- ratio of the total observation time of ACA relative to 
         that of 12m array. Set 0 for no ACA observation. 
         For Cycle-1, set acaratio = 0 or 3.
    acaconfig --- ACA configuration. Available configurations are:
       * "" (default) : automatically defines based on antennalist. 
               If antennalist is Cycle-1 configuration, acaconfig='cycle1'.
               Otherwise, acaconfig='i'
       * 'cycle1' : Cycle-1 ACA-7m configuration. Uses 'aca_cycle1.cfg'.
       * "i" : Normal ACA configuration in full operation. Uses 'aca.i.cfg'.
       * "ns": North-South extended configuration in full operation. 
               Uses 'aca.ns.cfg'.
    -------------------------------
    pwv -- precipitable water vapor if constructing an atmospheric model.
         Set 0 for noise-free simulation.
    -------------------------------
    image -- invert and deconvolve the simulated measurement set(s)
       * NOTE: interactive clean or more parameters than the subset visible
         here are available by simply running the clean task directly, 
         then returning to simdata to run "analyze" if desired.
       * NOTE: the channelization of the output image cube will be the 
         same as that in the simulated Measurement Set.
       * if graphics turned on, display the clean image and residual image
       * uses Cotton-Schwab clean for single fields and Mosaic gridding
         for multiple fields (with Clark PSF calculation in minor cycles).
    imsize -- image size in spatial pixels (x,y)
       0 or -1 will use the model image size; example: imsize=[500,500]
    imdirection -- phase center for synthesized image.  default is to 
       center on the sky model.
    cell -- cell size e.g '10arcsec'.  "" defaults to the skymodel cell
    niter -- number of clean/deconvolution iterations, 0 for no cleaning
    threshold -- flux level to stop cleaning
    -------------------------------
    graphics -- view plots on the screen, saved to file, both, or neither
    verbose -- print extra information to the logger and terminal
    overwrite -- overwrite existing files in the project subdirectory

    -------------------------------
    What does this task do:
    -------------------------------
    simalma is a task to simulate ALMA observation with simple interface. 
    It simulates ALMA 12m observation and optionally ACA 7m and Total power
    observations when acaratio > 0. 
    When image=True, simulated data are imaged and analyzed. CLEAN is used
    to generate image(s) from simulated data. ALMA 12m and ACA data are
    combined (if both geneareted) by taking ACA image as an initial model
    in CLEAN of ALMA 12m data.
    NOTE this task is very experimental and may not exactly reproduce
    actual ALMA products.

    The following assuptions are made to make the interface simple:
    * This task is intended to be run only once with a set of parameters.
      Therefore, it always sets up input model and pointings, and invokes simulation.
      You can stop before imaging step and reduce data manually with the other tasks,
      e.g, simanalyze, clean, and feather.
    * acaratio controls whether or not ACA observation is simulated. if acaratio > 0,
      ACA observation is simulated with total observation time = acaratio * totaltime
      for both ACA 7m and Total power array.
    * pwv controls whether or not thermal noise is applied to simulated data.
      When pwv > 0, the thermal noise is applied to simulated data. J. Pardo's ATM
      library is used to construct an atmospheric profile of the ALMA site.
    * ALMA 12m array does Nyquist sampling for mosaic if a list of directions are 
      not specified.
    * Total power array maps slightly (+1 PB) larger area compared to 12m array for
      later combined imaging.

    Please see the documents of simobserve and simanalyze for
    how to specify a model image, and list of outputs produced.

</example>
</task>
</casaxml>
